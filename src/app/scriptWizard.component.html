<paNavBar></paNavBar>
<div style="width: 100%; background-color: white;" class="border pl-3 pr-3 mb-3">
<!-- <p class="lead" *ngIf="viewScript=='0'">Select a script.</p> -->
<!-- <p class="lead" *ngIf="viewScript!='0'"><strong>Selected script: </strong><span *ngIf="selectedScript.name">{{selectedScript.name}}</span></p> -->
    <p class="lead">Manage your scripts.</p>
    <ng-container *ngIf="!isLoggedOut()">
        <div *ngIf="isAdmin() && currentUser!=1 && model.viewScript!='0'" class="row">
            <div class="col-sm-1" style="min-width: 10em;">
                <strong>Selected author:</strong>
            </div>
            <div class="col-sm">
                <span *ngIf="model.selectedScript.author">
                    {{model.selectedScript.author}}
                </span>
            </div>
        </div>

        <div *ngIf="model.viewScript!='0'" class="row mb-3">
            <div class="col">
                <div class="row">
                    <div class="col-sm-1" style="min-width: 10em;">
                        <strong>Selected script: </strong>
                    </div>
                    <div class="col-sm">
                        <span>
                            <span *ngIf="model.selectedScript.name">{{model.selectedScript.name}}</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-4" style="min-width: 8em;">
                <button *ngIf="editScriptStage==0" class="btn btn-secondary float-right mt-1" (click)="editScriptStage=0; showStageHelp=false; unselectScript();">Close script</button>
            </div>
        </div>
        
        <div *ngIf="model.viewScript=='0'" class="row mb-3">
            <div *ngIf="isAdmin() && !showallscripts" class="row mb-3">
                <div class="col-sm-1" style="min-width: 15em;">
                    <label class="form-check-label"><strong>Show scripts authored by:</strong></label>
                </div>
                <div class="col-sm" *ngIf="model.viewScript=='0'">
                    <select class="form-select form-select-sm" [(ngModel)]="currentUser" (change)="model.viewScript='0'; deleteStageConfirmationId=0; showStageHelp=false; newStageMessage=false; copyStageMessage=false;">
                        <option *ngFor="let user of getUsers();" value="{{user.id}}">   
                            {{user.id}}: {{user.username}}           
                        </option> 
                    </select> 
                </div>
            </div>

            <div class="form-group" *ngIf="getScripts().length > 12">
                <div class="row pt-1">
                    <div class="col-sm-2 pt-1" style="min-width: 12em;">
                       <label for="search-text">Filter my scripts:</label>
                    </div>
                    <div class="col-sm">
                        <input type="email" class="form-control" id="search-text" aria-describedby="search-text" 
                        [(ngModel)]="searchScriptText" placeholder="Title or description">
                    </div>
                </div>
            </div>

            <div class="col">&nbsp;</div>
            <div class="col-4" style="min-width: 8em;">
                <button class="btn btn-success float-right" (click)="addScript(); copyScriptMessage=false;" *ngIf="(!isAdmin() || (isAdmin() && currentUser==1))">New script</button>
            </div>
        </div>
    </ng-container>

</div>
<div *ngIf="model.viewScript=='0'" >
    <div class="mb-3 p-3 border" style="border-radius: 15px; background-color: white;" *ngFor="let script of getScripts() | appFilterScript: searchScriptText; let i = index">
    <div class="row">
        <div class="col-md">
            <h4>{{script.name}}</h4>
        </div>
        <div class="col-md-1" style="min-width: 18em;" *ngIf="isAdmin()">
            <button class="btn btn-secondary float-right" (click)="selectScript(script._id); showup(); copyScriptMessage=false;">Open script</button>
            <button class="btn btn-danger float-right mt-3" style="clear: both;" *ngIf="!script.removed && currentUser==1" (click)="copyScript(script);">Copy script</button>
            <button class="btn btn-success float-right mt-3" style="clear: both;" *ngIf="script.removed && currentUser!=1" (click)="restoreScript(script); copyScriptMessage=false;">Restore script</button>
            <button class="btn btn-danger float-right mt-3" style="clear: both;" *ngIf="!script.removed && currentUser!=1" (click)="removeScript(script); copyScriptMessage=false;">Remove script</button>
            <button class="btn btn-danger float-right mr-3 mt-3" (click)="confirmDelete(script._id); copyScriptMessage=false;">Delete script</button>
        </div>
        <div class="col-md-1" style="min-width: 16em;" *ngIf="!isAdmin()">
            <button class="btn btn-secondary float-right" (click)="selectScript(script._id); showup(); copyScriptMessage=false;">Open script</button>
            <button class="btn btn-success float-right mt-3" style="clear: both;" (click)="copyScript(script);">Copy script</button>
            <button class="btn btn-danger float-right mr-3 mt-3" (click)="confirmRemove(script._id); copyScriptMessage=false;">Remove script</button>
        </div>
    </div>
    <span *ngIf="copiedScript==script.id && copyScriptMessage">
        <div class="alert alert-success fadeout mt-3">{{copyScriptMessageText}}</div>
    </span>
    <div class="row" *ngIf="removeConfirmation_Id==script._id">
        <div class="alert alert-danger" role="alert"><strong>Are you sure you want to remove this script?</strong> <span><button class="btn btn-danger ml-2" (click)="removeScript(script)">OK</button> <button class="btn btn-secondary ml-2" (click)="removeConfirmation_Id=''">Cancel</button></span></div>
    </div>
    <div class="row" *ngIf="deleteConfirmation_Id==script._id">
        <div class="alert alert-danger" role="alert"><strong>Are you sure you want to delete this script?</strong> <span><button class="btn btn-danger ml-2" (click)="deleteScript(script._id)">OK</button> <button class="btn btn-secondary ml-2" (click)="deleteConfirmation_Id=''">Cancel</button></span></div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="row">
                <div class="col-sm-2" style="min-width: 8em;">
                    <strong>Author: </strong>
                </div>
                <div class="col-sm">
                    {{script.author}}
                </div>
            </div>
            <div class="row">
                <div class="col-sm-2" style="min-width: 8em;">
                    <strong>Artworks: </strong>
                </div>
                <div class="col-sm">
                    <span *ngFor="let artwork of getArtworksFromIds(script.name, script.artworkids, script);">
                        <span style="white-space: pre-wrap;" [innerHTML]="artwork.name"></span>, 
                        <span style="white-space: pre-wrap;" [innerHTML]="artwork.artist"></span>, 
                        <span>{{artwork.year}}</span><br/>
                    </span>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-2" style="min-width: 8em;">
                    <strong>Themes: </strong>
                </div>
                <div class="col-sm">
                    <span *ngFor="let theme of getThemesFromIds(script.themeids); let last = last">
                        {{theme.name}}<span *ngIf="!last">, </span>
                    </span>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-2" style="min-width: 8em;">
                    <strong>Description: </strong>
                </div>
                <div class="col-sm">
                    {{script.description}}
                </div>
            </div>
            <div class="row">
                <div class="col-sm-2" style="min-width: 8em;">
                    <strong>Homepage: </strong>
                </div>
                <div class="col-sm">
                    <span *ngFor="let artwork of getArtworkAsList(script.homepageartworkid);">
                        <ng-container *ngIf="artwork != undefined">
                            <span style="white-space: pre-wrap;" [innerHTML]="artwork.name"></span>, 
                            <span style="white-space: pre-wrap;" [innerHTML]="artwork.artist"></span>, 
                            <span>{{artwork.year}}</span>
                        </ng-container>
                    </span>
                </div>
            </div>
            <div class="row mt-1" *ngIf="script.open && script.stages.length > 0;">
                <div class="col-sm-2" style="min-width: 8em;">
                    <strong>Script: </strong>
                </div>
                <div class="col-sm">
                    <a routerLink='/slowLooking/{{script._id}}' [queryParams]="{return:'scripts'}">
                        <button class="btn btn-light mr-3">View script <i class='fa fa-link'></i></button>
                    </a>
                    <button class="btn btn-light" ngbPopover="{{scriptURL(script)}}" popoverTitle="Script URL copied to clipboard" ngxClipboard [cbContent]='scriptURL(script)'>Copy script URL <i class="fa fa-clone" aria-hidden="true"></i></button>
                </div>
            </div>
            <div class="row mt-1" *ngIf="script.stages.length > 0 && !statementOnlyScript(script)">
                <div class="col-sm-2" style="min-width: 8em;">
                    <strong>Responses: </strong>
                </div>
                <div class="col-sm">
                    <a routerLink='/allResponses/{{script._id}}'>
                        <button class="btn btn-light mr-3" (click)="reloadActivities();">View responses <i class='fa fa-link'></i></button>
                    </a>
                    <button class="btn btn-light" ngbPopover="{{responsesURL(script)}}" popoverTitle="Responses URL copied to clipboard" ngxClipboard [cbContent]='responsesURL(script)'>Copy responses URL <i class="fa fa-clone" aria-hidden="true"></i></button>
                </div>
            </div>
            <div class="row mt-1" *ngIf="isAdmin()">
                <div class="col-sm-2" style="min-width: 8em;">
                    <strong>Status: </strong>
                </div>
                <div class="col-sm">
                    <div class="form-check form-check-inline">
                        <input
                            class="form-check-input"
                            type="radio"
                            [value]=true
                            [checked]=script.open
                            (change) = toggleScriptStatus(script);
                        />
                        <label class="form-check-label">Open&nbsp;&nbsp;</label>
                        <input
                            class="form-check-input"
                            type="radio"
                            [value]=false
                            [checked]=!script.open
                            (change) = toggleScriptStatus(script);
                        />
                        <label class="form-check-label">Closed&nbsp;&nbsp;</label>
                    </div>
                    <div class = "help-block">Select Open to allow users to respond to this script, or Closed to prevent any responses. Open scripts can be accessed directly online even if they are Private.</div>
                </div>
            </div>
            <div class="row mt-1" *ngIf="isAdmin()">
                <div class="col-sm-2" style="min-width: 8em;">
                    <strong>Visibility: </strong>
                </div>
                <div class="col-sm">
                    <div class="form-check form-check-inline">
                        <input
                            class="form-check-input"
                            type="radio"
                            [value]=true
                            [checked]=script.visible
                            (change) = toggleScriptVisibility(script);
                        />
                        <label class="form-check-label">Public&nbsp;&nbsp;</label>
                        <input
                            class="form-check-input"
                            type="radio"
                            [value]=false
                            [checked]=!script.visible
                            (change) = toggleScriptVisibility(script);
                        />
                        <label class="form-check-label">Private&nbsp;&nbsp;</label>
                    </div>
                    <div *ngIf="!script.homepageartworkid && script.visible" class="text-info">Add a homepage artwork to the script to make it visible</div>
                    <div class = "help-block">Public scripts are shown on the Responses page. Selecting Public and Open means users can respond to the script and it will also be visible on the Home page.</div>
                </div>
            </div>
            <div class="row mt-1" *ngIf="isAdmin()">
                <div class="col-sm-2" style="min-width: 8em;">
                    <strong>New contributions: </strong>
                </div>
                <div class="col-sm">
                    <div class="form-check form-check-inline">
                        <input
                            class="form-check-input"
                            type="radio"
                            [value]=true
                            [checked]=!script.autoapproved
                            (change) = toggleScriptApproval(script);
                        />
                        <label class="form-check-label">Awaiting approval&nbsp;&nbsp;</label>
                        <input
                            class="form-check-input"
                            type="radio"
                            [value]=false
                            [checked]=script.autoapproved
                            (change) = toggleScriptApproval(script);
                        />
                        <label class="form-check-label">Approved&nbsp;&nbsp;</label>
                    </div>
                    <div class = "help-block">Awaiting approval means responses have to be moderated from the Management page. Approved means they will appear directly on the Responses page.</div>
                </div>
            </div>
            <div class="row mt-1" *ngIf="isAdmin()">
                <div class="col-sm-2" style="min-width: 8em;">
                    <strong>Featured: </strong>
                </div>
                <div class="col-sm">
                    <div class="form-check form-check-inline">
                        <input
                            class="form-check-input"
                            type="radio"
                            [value]=true
                            [checked]=script.featured
                            (change) = toggleScriptFeatured(script);
                        />
                        <label class="form-check-label">Featured&nbsp;&nbsp;</label>
                        <input
                            class="form-check-input"
                            type="radio"
                            [value]=false
                            [checked]=!script.featured
                            (change) = toggleScriptFeatured(script);
                        />
                        <label class="form-check-label">Not featured&nbsp;&nbsp;</label>
                    </div>
                    <div class = "help-block">Featured scripts are shown in the top panel on the homepage.</div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>


<div *ngIf="model.viewScript!='0'" style="width: 100%; background-color: white;" class="pl-3 pr-3 pt-1">
    <ul ngbNav #nav="ngbNav" class="nav-pills">
        <li ngbNavItem>
          <a ngbNavLink><strong>Artworks</strong></a>
          <ng-template ngbNavContent>
            <p>Choose the artworks for your script.</p>
            <div class="form-group" *ngIf="getArtworks(model.selectedScript).length > 12">
                <div class="row">
                    <div class="col-sm-2 pt-1" style="min-width: 12em;">
                       <label for="search-text">Filter my artworks:</label>
                    </div>
                    <div class="col-sm">
                        <input type="email" class="form-control" id="search-text" aria-describedby="search-text" 
                        [(ngModel)]="searchText" placeholder="Artwork, artist or year">
                    </div>
                </div>
            </div>
            <div class="alert alert-info" *ngIf="getArtworks(model.selectedScript).length == 0">
                Use the <strong>Artworks</strong> option from the top pull-down menu to add artworks to your personal collection. These can then be added to your scripts.
            </div>
            <div class="row itemsBlock">
                <div *ngFor="let artwork of getArtworks(model.selectedScript) | appFilter: searchText" class="col-md-4 col-sm-6 col-12 pb-3">
                    <div class="row pl-3">
                        <div class="col-1 align-self-center" style="width:5px;">
                            <div class="form-check">
                                <input 
                                class="form-check-input"
                                type="checkbox"
                                [value]=artwork._id
                                [ngModel] = "model.selectedScript.artworkids.includes(artwork._id)"
                                (change) = "artworksChange(model.selectedScript, artwork._id, $event)"
                                >
                            </div> 
                        </div>
                        <div class="col">
                            <div class="row">
                                <ng-container *ngIf="artwork.url">
                                    <img src="{{artwork.url}}" alt="{{artwork.name}}" height="auto" width="100%" (error)="handleMissingImage($event)">
                                </ng-container>
                            </div>
                            <div class="row">
                                <label class="form-check-label"> 
                                <div class="ml-3">
                                    <div class="row text-left" style="white-space: pre-wrap; line-height: 1.2;" [innerHTML]="artwork.name"></div>
                                    <strong><div class="row text-left" style="white-space: pre-wrap; line-height: 1.2;" [innerHTML]="artwork.artist"></div></strong>
                                    <div class="row text-left" style="white-space: pre-wrap; line-height: 1.2;" [innerHTML]="artwork.year"></div>
                                </div>
                                    <!-- <div><span style="white-space: pre-wrap;" [innerHTML]="artwork.name"></span></div>
                                    <div><strong><span style="white-space: pre-wrap;" [innerHTML]="artwork.artist"></span></strong></div>
                                    <div>{{artwork.year}}</div> -->
                                </label>
                            </div>
                        </div>
                    </div>
              
                </div>
            </div>

            <!-- <div *ngFor="let artwork of getArtworks(model.selectedScript)" class="form-check form-check-inline pb-3 ml-1" style="width: 260px;"> -->
            <!-- <div *ngFor="let artwork of getArtworks(model.selectedScript)" class="form-check form-check-inline pb-3 ml-1" style="width: 260px;">
     
                <div class=" align-self-center" style="width: 30px;">
                    <input 
                    class="form-check-input"
                    type="checkbox"
                    [value]=artwork._id
                    [ngModel] = "model.selectedScript.artworkids.includes(artwork._id)"
                    (change) = "artworksChange(model.selectedScript, artwork._id, $event)"
                    />
                </div>
                <div class="col-sm">
                    <div class="row">
                        <span *ngIf="artwork.url">
                            <img src="{{artwork.url}}" alt="{{artwork.name}}" height="auto" width="200px" >
                        </span>
                    </div>
                    <div class="row">
                        <label class="form-check-label"> 
                        <div class="ml-3">
                            <div class="row text-left" style="white-space: pre-wrap; line-height: 1.2;" [innerHTML]="artwork.name"></div>
                            <strong><div class="row text-left" style="white-space: pre-wrap; line-height: 1.2;" [innerHTML]="artwork.artist"></div></strong>
                            <div class="row text-left" style="white-space: pre-wrap; line-height: 1.2;" [innerHTML]="artwork.year"></div>
                        </div>

                        </label>
                    </div>
                </div>
          
            </div> -->
            <br/><br/>
           </ng-template>
        </li>
        <li ngbNavItem>
          <a ngbNavLink><strong>Stages</strong></a>
          <ng-template ngbNavContent>
            <p>Manage the stages of your script.</p>
            <div class="row" *ngIf="editScriptStage==0">
                <div class="col-sm-2">
                    <span class="font-weight-bold">Add stage:</span>
                </div>
                <div class="col-sm-10">
                    <button class="btn btn-success mr-2 mb-1" (click)="addStatementStageToScript(model.selectedScript); deleteStageConfirmationId=0; showStageHelp=false;">statement</button> 
                    <button class="btn btn-success mr-2 mb-1" (click)="addQuestionStageToScript(model.selectedScript); deleteStageConfirmationId=0; showStageHelp=false;">question</button> 
                    <button class="btn btn-success mr-2 mb-1" (click)="addMultiQuestionStageToScript(model.selectedScript); deleteStageConfirmationId=0; showStageHelp=false;">multiquestion</button> 
                    <button class="btn btn-success mr-2 mb-1" (click)="addStoryStageToScript(model.selectedScript); deleteStageConfirmationId=0; showStageHelp=false;">story</button>
                    <img class="mb-1" width="25" style="background-color:white; cursor: pointer;" src="assets/img/question-help.png" (click)="toggleStageHelp(); newStageMessage=false; copyStageMessage=false;">
                </div>
            </div>
            <div *ngIf="editScriptStage==0 && newStageMessage" class="alert alert-success fadeout">
                {{newStageMessageText}}
            </div>
            <div *ngIf="editScriptStage==0 && showStageHelp" class="alert alert-info">
                <div class="row">
                    <div class="col-sm-2" style="min-width: 9em;">
                        <span class="font-weight-bold">statement: </span>
                    </div>
                    <div class="col-sm">
                        <span>Provide a statement giving information or a perspective</span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-2" style="min-width: 9em;">
                        <span class="font-weight-bold">question: </span>
                    </div>
                    <div class="col-sm">
                        <span>Ask a question and optionally provide a help prompt</span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-2" style="min-width: 9em;">
                        <span class="font-weight-bold">multiquestion: </span>
                    </div>
                    <div class="col-sm">
                        <span>Add a number of questions to one stage which can be shuffled at random or shown in sequence</span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-2" style="min-width: 9em;">
                        <span class="font-weight-bold">story: </span>
                    </div>
                    <div class="col-sm">
                        <span>Provide a story stem or story starter to be completed</span>
                    </div>
                </div>
            </div>


            <table width=100%>
                <tbody cdkDropList (cdkDropListDropped)="stageDrop(model.selectedScript, $event)">
                <tr *ngFor="let stage of model.selectedScript.stages; let i = index" class="border-top border-bottom mt-3 p-3 mb-3" cdkDrag cdkDragLockAxis="y">
                <td>
                    <!-- show script stage -->
                    <span *ngIf="stage.id!=editScriptStage"> 
                        <span class="drag-handle" style="cursor: move;" cdkDragHandle>
                            <span *ngIf="editScriptStage==0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                            </span>
                        </span>{{i+1}}<br/>
                        <!-- <span class="font-weight-bold">&nbsp;Position: </span><span>{{i+1}}</span><br/> -->
                        <div class="row">
                            <div class="col-sm-2" style="min-width: 8em;">
                                <span class="font-weight-bold">Title: </span>
                            </div>
                            <div class="col-sm">
                                <span>{{stage.title}}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-2" style="min-width: 8em;">
                                <span class="font-weight-bold">Type: </span>
                            </div>
                            <div class="col-sm">
                                <span>{{stage.stagetype}}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-2" style="min-width: 8em;">
                                <span class="font-weight-bold">Artworks: </span>
                            </div>
                            <div class="col-sm">
                                <span *ngIf="!getArtworksFromIds(model.selectedScript.name, model.selectedScript.artworkids, model.selectedScript).length" class="text-info">
                                    Select artworks for your script from the Artworks tab.
                                </span>
                                <span *ngFor="let artwork of getArtworksFromIds(stage.title, stage.includeartworks, model.selectedScript, stage);">
                                    <span style="white-space: pre-wrap;" [innerHTML]="artwork.name"></span>, <span style="white-space: pre-wrap;" [innerHTML]="artwork.artist"></span>, {{artwork.year}}<br/>
                                </span>
                            </div>
                        </div>
                        <div class="row" *ngIf='stage.stagetype=="multiquestion"'>
                            <div class="col-sm-2" style="min-width: 8em;">
                                <span class="font-weight-bold">Style: </span>
                            </div>
                            <div class="col-sm">
                                <span *ngIf='stage.sequential'>Questions presented in sequence</span>
                                <span *ngIf='!stage.sequential'>Random question that can be shuffled</span>
                            </div>
                        </div>
                        <div class="row" *ngIf='stage.stagetype=="multiquestion"'>
                            <div class="col-sm-2" style="min-width: 8em;">
                                <span class="font-weight-bold">Help text: </span>
                            </div>
                            <div class="col-sm">
                                <span style="white-space: pre-wrap;" [innerHTML]="stage.help | linkify"></span>
                            </div>
                            
                        </div>
                        <ng-container *ngIf='stage.stagetype=="multiquestion"'>
                            <ng-container *ngFor="let question of stage.questions; let i=index">
                                <div class="row">
                                    <div class="col-sm-2" style="min-width: 8em;">
                                        <span class="font-weight-bold">Question {{i+1}}: </span>
                                    </div>
                                    <div class="col-sm">
                                        <span style="white-space: pre-wrap;" [innerHTML]="question.title | linkify"></span>
                                    </div>
                                </div>
                                <div class="row" *ngIf="question.choice">
                                    <div class="col-sm-2" style="min-width: 8em;">
                                        <strong>Options {{i+1}}: </strong>
                                    </div>
                                    <div class="col-sm">
                                        <span *ngFor="let option of question.options; let last=last;">
                                            {{option}}<span *ngIf="!last">, </span>
                                        </span>
                                    </div>
                                </div>
                            </ng-container>
                        </ng-container>

                        <div class="row" *ngIf='stage.stagetype=="story"'>
                            <div class="col-sm-2" style="min-width: 8em;">
                                <span class="font-weight-bold">Help text: </span>
                            </div>
                            <div class="col-sm">
                                <span style="white-space: pre-wrap;" [innerHTML]="stage.help | linkify"></span>
                            </div>
                        </div>
                        
                        <div class="row" *ngIf='stage.stagetype=="statement" || stage.stagetype=="story"'>
                            <div class="col-sm-2" style="min-width: 8em;">
                                <span class="font-weight-bold">Text: </span>
                            </div>
                            <div class="col-sm">
                                <span style="white-space: pre-wrap;" [innerHTML]="stage.body | linkify"></span>
                            </div>
                        </div>

                        <ng-container *ngIf='stage.stagetype=="question"'>
                            <div class="row" *ngIf='stage.stagetype=="question"'>
                                <div class="col-sm-2" style="min-width: 8em;">
                                    <span class="font-weight-bold">Text: </span>
                                </div>
                                <div class="col-sm">
                                    <span style="white-space: pre-wrap;" [innerHTML]="stage.question.title | linkify"></span>
                                </div>
                            </div>
                            <div class="row" *ngIf="stage.question.choice">
                                <div class="col-sm-2" style="min-width: 8em;">
                                    <strong>Options: </strong>
                                </div>
                                <div class="col-sm">
                                    <span *ngFor="let option of stage.question.options; let last=last;">
                                    {{option}}<span *ngIf="!last">, </span>
                                </span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-2" style="min-width: 8em;">
                                    <span class="font-weight-bold">Help text: </span>
                                </div>
                                <div class="col-sm">
                                    <span style="white-space: pre-wrap;" [innerHTML]="stage.help | linkify"></span>
                                </div>
                            </div>
                        </ng-container>
                        
                        <span *ngIf="editScriptStage==0 && editScriptDescription=='0'"> 
                            <!-- <span class="float">&nbsp;</span> -->
                            <span class="float-right">
                                <button class="btn btn-danger mb-1 mr-2" (click)="confirmStageDelete(stage.id); showStageHelp=false; newStageMessage=false; copyStageMessage=false;">Delete stage</button>
                                <button class="mr-2 btn btn-success mb-1" (click)="copyStage(i, stage.id); showStageHelp=false; newStageMessage=false;">Copy stage</button>
                                <button class="btn btn-warning mb-1" (click)="editScriptStage=stage.id; deleteStageConfirmationId=0; showStageHelp=false; newStageMessage=false; copyStageMessage=false;">Edit stage</button>
                            </span>
                        </span><br/>
                        <span *ngIf="copiedStage==stage.id && copyStageMessage">
                            <div class="alert alert-success fadeout mt-3">{{copyStageMessageText}}</div>
                        </span>
                        <span *ngIf="deleteStageConfirmationId==stage.id">
                            <div class="alert alert-danger mt-3" role="alert"><strong>Are you sure you want to delete this stage?</strong> <div><button class="btn btn-danger ml-2" (click)="deleteStage(model.selectedScript, stage); deleteStageConfirmationId=0; showStageHelp=false;">OK</button> <button class="btn btn-secondary ml-2" (click)="deleteStageConfirmationId=0; showStageHelp=false;">Cancel</button></div></div>
                        </span>
                    </span>
                    <!-- edit script stage -->
                    <span *ngIf="stage.id==editScriptStage">
                        <span class="drag-handle" style="cursor: move;" cdkDragHandle>
                        </span>
                        {{i+1}}<br/>
                        <div class="row">
                            <div class="col-sm-2" style="min-width: 8em;">
                                <span class="font-weight-bold">Type:</span>
                            </div>
                            <div class="col-sm">
                                <span>{{stage.stagetype}}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-2" style="min-width: 8em;">
                                <span class="font-weight-bold">Title:</span>
                            </div>
                            <div class="col-sm">
                                <textarea rows="1" class="form-control" [(ngModel)]="stage.title"></textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-2" style="min-width: 8em;">
                                <span class="font-weight-bold">Artworks: </span>
                            </div>
                            <div class="col-sm">
                                <div *ngIf="!getArtworksFromIds(model.selectedScript.name, model.selectedScript.artworkids, model.selectedScript).length" class="text-info">
                                    Select artworks for your script from the Artworks tab.
                                </div>
                                <table>
                                    <tr *ngFor="let artwork of getArtworksFromIds(model.selectedScript.name, model.selectedScript.artworkids, model.selectedScript)" class="mr-3">
                                        <td class="align-middle">
                                            <div class="form-check form-check-inline">
                                                <input
                                                class="form-check-input"
                                                type="checkbox"
                                                [value]=artwork._id
                                                [ngModel] = "stage.includeartworks.includes(artwork._id)"
                                                (change) = "includeArtworksChange(model.selectedScript, stage, artwork._id, $event)"
                                                />
                                            </div>
                                        </td>
                                        <!-- <td class="align-top">
                                            <span *ngIf="artwork.url">
                                                <img src="{{artwork.url}}" alt="{{artwork.name}}" class="img-thumbnail" height="auto" width="150px" >
                                            </span>
                                        </td> -->
                                        <td class="align-top">
                                            <!-- <label class="form-check-label"> 
                                                <div class="col-sm-12"><strong><span style="white-space: pre-wrap;" [innerHTML]="artwork.name"></span></strong></div>
                                                <div class="col-sm-12"><span style="white-space: pre-wrap;" [innerHTML]="artwork.artist"></span></div>
                                                <div class="col-sm-12">{{artwork.year}}</div>
                                            </label> -->
                                            <label class="form-check-label"><span style="white-space: pre-wrap;" [innerHTML]="artwork.name"></span>, <span style="white-space: pre-wrap;" [innerHTML]="artwork.artist"></span>, {{artwork.year}} </label>
                                        </td>
                                        <br/>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div class="row" *ngIf='stage.stagetype=="multiquestion"'>
                            <div class="col-sm-2" style="min-width: 8em;">
                                <span class="font-weight-bold">Style: </span>
                            </div>
                            <div class="col-sm">
                                <div class="form-check form-check-inline">
                                    <input
                                    type="radio"
                                    class="form-check-input"
                                    [value]=true
                                    name="sequential"
                                    [(ngModel)] = "stage.sequential"
                                    />
                                </div>
                                <label class="form-check-label ml-1">Questions presented in sequence</label><br/>
                                <div class="form-check form-check-inline">
                                    <input
                                    type="radio"
                                    class="form-check-input"
                                    [value]=false
                                    name="sequential"
                                    [(ngModel)] = "stage.sequential"
                                    />
                                </div>
                                <label class="form-check-label ml-1">Random question that can be shuffled</label>
                            </div>
                        </div>

                        <div class="row" *ngIf='stage.stagetype=="story" || stage.stagetype=="multiquestion"'>
                            <div class="col-sm-2" style="min-width: 8em;">
                                <span class="font-weight-bold">Help text:</span>
                            </div>
                            <div class="col-sm">
                                <textarea rows="3" class="form-control" [(ngModel)]="stage.help"></textarea>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-2" style="min-width: 8em;">
                                <span class="font-weight-bold">Text:</span>
                            </div>
                            <div class="col-sm">
                                <span *ngIf='stage.stagetype!="multiquestion" && stage.stagetype!="question"'>
                                    <textarea rows="5" class="form-control" [(ngModel)]="stage.body"></textarea>
                                </span>
                                <!-- <ng-container *ngIf='stage.stagetype=="question"'> -->
                                <span *ngIf='stage.stagetype=="question"'>
                                    <textarea rows="3" class="form-control" [(ngModel)]="stage.question.title"></textarea>
                                </span>

                                <table *ngIf='stage.stagetype=="question"'>
                                    <tr>
                                        <td class="align-middle">
                                        <div class="form-check form-check-inline">
                                            <input
                                                class="form-check-input"
                                                type="checkbox"
                                                [value]="stage.question.choice"
                                                [(ngModel)] = "stage.question.choice"
                                                (click) = "checkQuestionOptions(model.selectedScript, i);"
                                            /> 
                                        </div>          
                                        </td>
                                        <td class="align-top">
                                            <label class="form-check-label">Multiple choice</label>
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        </td>
                                        <td class="align-middle">
                                            <div *ngIf="stage.question.choice" class="form-check form-check-inline">
                                                <input
                                                    class="form-check-input"
                                                    type="checkbox"
                                                    [value]="stage.question.mulitselect"
                                                    [(ngModel)] = "stage.question.mulitselect"
                                                /> 
                                            </div>          
                                        </td>
                                        <td class="align-top">
                                            <label *ngIf="stage.question.choice" class="form-check-label">Multiple selections</label>
                                        </td>
                                    </tr>
                                </table>
                                <table *ngIf='stage.stagetype=="question" && stage.question.choice' style="width: 100%; background-color:#EEEEEE;">
                                    <tr *ngFor="let option of stage.question.options; let index=index; trackBy:trackByIdx">
                                        <td>
                                            <textarea rows="1" class="form-control" [(ngModel)]="stage.question.options[index]"></textarea>
                                        </td><td><button class="btn btn-danger float-right" (click)="deleteQuestionOption(model.selectedScript, i, index);" [disabled]="stage.question.options.length < 3">Delete option</button></td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <button class="btn btn-success" (click)='stage.question.options = stage.question.options.concat("Option ".concat(stage.question.options.length+1));'>Add option</button>
                                        </td>
                                    </tr>
                                </table>

                                <!-- </ng-container> -->
                                <span *ngIf='stage.stagetype=="multiquestion"'>
                                    <table style="width: 100%;">
                                        <tbody cdkDropList (cdkDropListDropped)="drop($event, model.selectedScript, i)">
                                            <tr *ngFor="let q of stage.questions; let index=index; trackBy:trackByIdx" cdkDrag cdkDragLockAxis="y">
                                                <td>
                                                    <span class="drag-handle" style="cursor: move;" cdkDragHandle>
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
                                                            <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                                                        </svg>
                                                    </span>
                                                    <span class="font-weight-bold">Question {{index+1}}: </span><br/><textarea rows="3" class="form-control" [(ngModel)]="stage.questions[index].title"></textarea>
                                                    <div class="ml-2 row">
                                                        <div class="col">
                                                            <input
                                                            class="form-check-input"
                                                            type="checkbox"
                                                            [value]="stage.questions[index].choice"
                                                            [(ngModel)] = "stage.questions[index].choice"
                                                            (click) = "checkMultiquestionOptions(model.selectedScript, i, index);"
                                                            /> 
                                                            <label class="form-check-label ml-2">Multiple choice</label>
                                                        </div>
                                                        <div class="col" *ngIf="stage.questions[index].choice">
                                                            <input
                                                            class="form-check-input"
                                                            type="checkbox"
                                                            [value]="stage.questions[index].choice"
                                                            [(ngModel)] = "stage.questions[index].mulitselect"
                                                            /> 
                                                            <label class="form-check-label ml-2">Multiple selections</label>
                                                        </div>
                                                        <div class="col" style="min-width: 10em;">
                                                            <button class="btn btn-danger float-right" (click)="deleteMultistageQuestion(model.selectedScript, i, index)" [disabled]="stage.questions.length < 3">Delete question</button>
                                                        </div>
                                                    </div>
                                                    <table *ngIf='stage.stagetype=="multiquestion" && stage.questions[index].choice' style="width: 100%; background-color:#EEEEEE;">
                                                        <tr *ngFor="let option of stage.questions[index].options; let oi=index; trackBy:trackByIdx">
                                                            <td>
                                                                <textarea rows="1" class="form-control" [(ngModel)]="stage.questions[index].options[oi]"></textarea>
                                                            </td><td><button class="btn btn-danger float-right" (click)="deleteMultiquestionOption(model.selectedScript, i, index, oi)">Delete option</button></td>
                                                        </tr>
                                                        <tr *ngIf="!stage.questions[index].options.length">
                                                            <td class="alert alert-info" >
                                                                As this multiple choice question has no options it will be displayed as a statement.
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                <button class="btn btn-success" (click)='stage.questions[index].options = stage.questions[index].options.concat("Option ".concat(stage.questions[index].options.length+1));'>Add option</button>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr> 
                                        </tbody>
                                    </table>
                                </span>
                            </div>
                        </div>
                        <div class="row" *ngIf='stage.stagetype=="question"'>
                            <div class="col-sm-2" style="min-width: 8em;">
                                <span class="font-weight-bold">Help text:</span>
                            </div>
                            <div class="col-sm">
                                <textarea rows="3" class="form-control" [(ngModel)]="stage.help"></textarea>
                            </div>
                        </div>

                        <div class="row" *ngIf='stage.stagetype=="multiquestion"'>
                            <div class="col-sm-2" style="min-width: 8em;">
                                &nbsp;
                            </div>
                            <div class="col-sm">
                                <button class="btn btn-success mr-3" (click)='stage.questions = stage.questions.concat(initializeNewQuestion())'>Add new question</button>
                            </div>
                        </div>
                        
                      
                        <span>
                            <button class="btn btn-warning float-right" (click)="editScriptStage=0; saveScript(model.selectedScript)">Save stage</button><br/>
                        </span>
                    </span>
                </td>
                </tr>
                </tbody>
                </table>
                <br/><br/>
          </ng-template>
        </li>
        <li ngbNavItem>
            <a ngbNavLink><strong>Themes</strong></a>
            <ng-template ngbNavContent>
                <p>
                    Choose one or more themes for your script.
                </p>
                <div *ngFor="let theme of getThemes()" class="form-check form-check-inline pr-3 pb-2">
                    <!-- <span style="float: left;" class="mr-2 form-check form-check-inline"> -->
                    <input
                    class="form-check-input"
                    type="checkbox"
                    [value]=theme._id
                    [ngModel] = "model.selectedScript.themeids.includes(theme._id)"
                    (change) = "themesChange(model.selectedScript, theme._id, $event)"
                    />
                    <label class="form-check-label">{{theme.name}}&nbsp;&nbsp;</label>
                    <!-- </span> -->
                </div>
                <br/><br/>
            </ng-template>
        </li>
        <li ngbNavItem>
            <a ngbNavLink><strong>Title</strong></a>
            <ng-template ngbNavContent>
                <p>
                    Decide how your script will be presented in Deep Viewpoints. 
                </p>

                <div class="row pb-3">
                    <div class="col-sm-3" style="min-width: 7em;">
                        <span class="font-weight-bold">Title: </span>
                    </div>
                    <div class="col-sm">
                        <textarea rows="2" class="form-control" [(ngModel)]="model.selectedScript.name" (change)="saveScript(model.selectedScript)"></textarea>
                    </div>
                </div>

                <div class="row pb-3">
                    <div class="col-sm-3" style="min-width: 7em;">
                        <span class="font-weight-bold">Description:</span>
                    </div>
                    <div class="col-sm">
                        <textarea rows="3" class="form-control" [(ngModel)]="model.selectedScript.description" (change)="saveScript(model.selectedScript)"></textarea>
                        <div class = "help-block">A short description of what the script is about, what will it involve, why people should take part</div>
                    </div>
                </div>

                <div class="row pb-3">
                    <div class="col-sm-3" style="min-width: 7em;">
                        <span class="font-weight-bold">Homepage artwork: </span>
                    </div>
                    
                    <div class="col-sm">
                        <div *ngIf="!getArtworksFromIds(model.selectedScript.name, model.selectedScript.artworkids, model.selectedScript).length" class="text-info">
                            Select artworks for your script from the Artworks tab.
                        </div>
                        <div *ngFor="let artwork of getArtworksFromIds(model.selectedScript.name, model.selectedScript.artworkids, model.selectedScript)">
                            <div class="form-check form-check-inline">
                                <input
                                style="vertical-align: top;"
                                class="form-check-input"
                                type="radio"
                                [value]="artwork._id"
                                name="artwork.name"
                                [(ngModel)] = "model.selectedScript.homepageartworkid"
                                (change) = "saveScript(model.selectedScript)"
                                />
                                <label class="form-check-label"><span style="white-space: pre-wrap;" [innerHTML]="artwork.name"></span>, <span style="white-space: pre-wrap;" [innerHTML]="artwork.artist"></span>, {{artwork.year}} </label>
                            </div>
                        </div>
                    </div>
                </div>
                <br/><br/>
            </ng-template>
        </li>
        <li ngbNavItem *ngIf="isAdmin()">
            <a ngbNavLink><strong>Advanced</strong></a>
            <ng-template ngbNavContent>
                <h4 class="mt-3">Shuffle</h4>
                <p>
                    Shuffle selected stages each time the script is used.
                </p>
                <div *ngFor="let stage of model.selectedScript.stages; let i = index" class="form-check mr-1 pb-2 ml-2">
                    <input 
                    class="form-check-input"
                    type="checkbox"
                    [value]=stage.id
                    [(ngModel)] = model.selectedScript.stages[i].shuffle
                    (change) = "saveScript(model.selectedScript)"
                    />
                    <label class="form-check-label">{{i+1}} {{stage.title}} <strong>Type:</strong> {{stage.stagetype}}</label>
                </div>
                <h4 class="mt-3">Required</h4>
                <p>
                    Require a response to the prompt or prompts within selected stages (question, multiquestion, story) before moving to the next stage.
                </p>
                <ng-container *ngFor="let stage of model.selectedScript.stages; let i = index">
                    <ng-container *ngIf="stage.stagetype != 'statement'">
                        <div class="form-check mr-1 pb-2 ml-2">
                            <input 
                            class="form-check-input"
                            type="checkbox"
                            [value]=stage.id
                            [(ngModel)] = model.selectedScript.stages[i].required
                            (change) = "saveScript(model.selectedScript)"
                            />
                            <label class="form-check-label">{{i+1}} {{stage.title}} <strong>Type:</strong> {{stage.stagetype}}</label>
                        </div>
                    </ng-container>
                </ng-container>
                <br/><br/>
            </ng-template>
        </li>
        <li ngbNavItem *ngIf="isAdmin()">
            <a ngbNavLink><strong>Exhibitions</strong></a>
            <ng-template ngbNavContent>
                <p>
                    Choose any exhibitions related to your script.
                </p>
                <div *ngFor="let exhibition of getExhibitions()" class="form-check mr-1 pb-2 ml-2">
                    <input
                    class="form-check-input"
                    type="checkbox"
                    [value]=exhibition._id
                    [ngModel] = "model.selectedScript.exhibitionids.includes(exhibition._id)"
                    (change) = "exhibitionsChange(model.selectedScript, exhibition._id, $event)"
                    />
                    <label class="form-check-label">{{exhibition.name}}&nbsp;&nbsp;</label>
                </div>
                <br/><br/>
            </ng-template>
        </li>
      </ul>
      <div [ngbNavOutlet]="nav"></div>
</div>
<br/>
<br/>

